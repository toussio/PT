<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PT íŠ¸ë ˆì´ë„ˆ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
<style>
:root{
  --bg:#FFDEB3;--card:#FFF3E0;--accent:#f97316;
  --grad:linear-gradient(135deg,#ffb77a,#f97316,#ea580c);
  --ink:#2b1d12;--muted:#5c4033;--disabled:#bfa89c;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink);overflow-x:hidden;}
/* ì¸íŠ¸ë¡œ */
.intro-overlay{position:fixed;inset:0;background:url('https://images.unsplash.com/photo-1558611848-73f7eb4001a1?auto=format&fit=crop&w=1400&q=80') center/cover no-repeat;
display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;text-align:center;color:#fff;backdrop-filter:blur(6px);}
.intro-bg{position:absolute;inset:0;background:rgba(0,0,0,0.4);}
.intro-content{position:relative;z-index:2;max-width:800px;background:rgba(255,243,224,0.92);
padding:40px 30px;border-radius:20px;box-shadow:0 0 20px rgba(249,115,22,0.4);color:var(--ink);}
.intro-content h1{margin:0 0 8px;font-size:2rem;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.intro-controls{display:flex;flex-direction:column;gap:10px;align-items:center;}
.intro-controls input{padding:10px 14px;border-radius:10px;border:2px solid #ffd6a5;width:70%;font-size:15px;background:#fff;}
.intro-controls button{background:var(--grad);color:#fff;border:none;padding:10px 24px;border-radius:12px;font-weight:600;cursor:pointer;
box-shadow:0 0 10px rgba(249,115,22,.4);transition:.3s;}
.intro-controls button:hover{transform:translateY(-3px);box-shadow:0 0 18px rgba(249,115,22,.6);}

/* floating buttons */
.floating-btn{position:fixed;border:none;border-radius:50px;padding:12px 20px;font-weight:700;color:white;cursor:pointer;background:var(--grad);
box-shadow:0 4px 14px rgba(249,115,22,0.3);z-index:1500;transition:all .3s ease;}
.floating-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(249,115,22,0.5);}
.floating-notice{top:20px;right:20px;}
.floating-admin{bottom:20px;right:20px;}

/* ê³µì§€/ê´€ë¦¬ì ëª¨ë‹¬ */
.notice-modal,.admin-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:3000;}
.notice-content,.admin-content{
  background:#fffaf3;border-radius:16px;padding:30px 40px;max-width:1000px;width:92%;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);animation:fadePop .5s ease;max-height:85vh;overflow-y:auto;
}
.notice-content h2,.admin-content h2{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:0;text-align:center;}
.notice-content ul{list-style:none;padding:0;margin:10px 0;}
.notice-content li{background:rgba(255,243,224,0.8);border-left:4px solid var(--accent);padding:12px 16px;border-radius:10px;margin:8px 0;
box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.notice-close,.admin-close{float:right;font-weight:700;color:var(--accent);cursor:pointer;font-size:18px;}

/* ê´€ë¦¬ì íƒ­ */
.tab-btns{display:flex;gap:10px;justify-content:center;margin-bottom:15px;flex-wrap:wrap}
.tab-btn{padding:8px 16px;border:none;border-radius:8px;background:#ffd6a5;font-weight:700;cursor:pointer;}
.tab-btn.active{background:var(--grad);color:white;}
.tab-content{display:none;}
.admin-table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:12px;overflow:hidden}
.admin-table th,.admin-table td{border:1px solid #ffd6a5;padding:8px;text-align:center;font-size:14px}

/* ë©”ì¸ ì˜ˆì•½ ì„¹ì…˜ */
.main{display:none;padding:40px 20px 80px;animation:fadeInMain 1s ease;}
h2.title{text-align:center;font-size:1.8rem;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px;}
#trainerTitle{text-align:center;font-size:1.1rem;color:var(--muted);margin-bottom:16px;}
.trainer-section{display:flex;justify-content:center;align-items:center;gap:30px;margin-bottom:16px;}
.arrow{background:var(--grad);border:none;border-radius:50%;width:55px;height:55px;display:flex;align-items:center;justify-content:center;
cursor:pointer;transition:.3s;box-shadow:0 0 10px rgba(249,115,22,.3);color:#fff;font-weight:900}
.arrow:hover{transform:scale(1.08);box-shadow:0 0 18px rgba(249,115,22,.6);}
.trainer-card{width:280px;border-radius:20px;background:var(--card);box-shadow:0 4px 10px rgba(0,0,0,.1);
text-align:center;overflow:hidden;transition:.3s;}
.trainer-card img{width:100%;height:180px;object-fit:cover;}
.trainer-card h3{margin:10px 0 4px;color:var(--accent);}
.trainer-card p{margin:0;color:var(--muted);}
.schedule-section{max-width:820px;margin:0 auto;background:var(--card);border-radius:20px;padding:24px 20px;box-shadow:0 0 20px rgba(0,0,0,.08);}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-weight:700;color:var(--muted);margin:0 0 6px;}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:6px;padding-bottom:10px;}
.day{text-align:center;padding:10px 0;border-radius:10px;background:rgba(255,255,255,0.78);cursor:pointer;transition:.25s;font-size:14px;min-height:55px;
display:flex;align-items:center;justify-content:center;font-weight:600;}
.day.booked{background:var(--grad);color:#fff;}
.day.disabled{opacity:.4;cursor:not-allowed;}
.day:hover:not(.disabled):not(.booked){background:rgba(249,115,22,.25);transform:scale(1.05);}
.day.selected{outline:2px solid var(--accent);}
.time-select-area{margin-top:18px;display:flex;flex-direction:column;align-items:center;gap:14px;}
.time-select-area select{width:85%;background:#fffaf3;border:2px solid #ffd6a5;border-radius:20px;padding:14px 16px;font-size:15px;font-weight:600;color:var(--ink);}
button.reserve-btn{width:85%;background:var(--grad);color:#fff;border:none;border-radius:24px;padding:16px 18px;font-size:17px;font-weight:700;cursor:pointer;}
button.reserve-btn:disabled{opacity:.6;cursor:not-allowed}

/* 24ì‹œê°„ìš© ì‹œê°„ì¹© ìŠ¤íƒ€ì¼ */
.time-chip{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:#fff;border:2px solid #ffd6a5;border-radius:10px;
padding:6px 10px;font-weight:600;min-width:90px;box-shadow:0 2px 6px rgba(249,115,22,0.08);transition:.2s;}
.time-chip input{margin-right:6px}
.time-chip:hover{background:#fff7ed;transform:scale(1.03);}

/* ì‹œê°„ì¹© ê·¸ë¦¬ë“œ */
.time-grid{display:flex;gap:12px;flex-wrap:wrap}
#timeGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin:12px 0 20px;justify-items:center}

/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:#fff8ee;color:var(--ink);border:2px solid #ffd6a5;border-radius:14px;
padding:12px 24px;font-weight:600;font-size:15px;box-shadow:0 4px 15px rgba(249,115,22,0.2);animation:fadeInOut 3s ease forwards;z-index:4000;}
@keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,20px);}10%,90%{opacity:1;transform:translate(-50%,0);}100%{opacity:0;transform:translate(-50%,20px);}}
@keyframes fadeInMain{from{opacity:0}to{opacity:1}}
@keyframes fadePop{from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>

<!-- ì¸íŠ¸ë¡œ -->
<div class="intro-overlay" id="intro" aria-hidden="false">
  <div class="intro-bg"></div>
  <div class="intro-content" role="dialog" aria-modal="true" aria-labelledby="introTitle">
    <h1 id="introTitle">ğŸ‹ï¸â€â™€ï¸ FITë¸”ë¦¬ PT ì„¼í„°</h1>
    <p>ë‹¹ì‹ ì˜ ëª¸ì„ ë””ìì¸í•˜ëŠ” ê³³ â€” ìµœê³ ì˜ íŠ¸ë ˆì´ë„ˆë“¤ê³¼ í•¨ê»˜í•˜ì„¸ìš”.</p>
    <div class="intro-controls">
      <input id="userId" placeholder="ê³ ë²ˆ ì…ë ¥" autocomplete="off" />
      <input id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" autocomplete="off" />
      <button id="startBtn">ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- ë©”ì¸ -->
<div class="main" id="main" aria-hidden="true">
  <h2 class="title">íŠ¸ë ˆì´ë„ˆ ì˜ˆì•½ ì‹œìŠ¤í…œ</h2>
  <h3 id="trainerTitle">íŠ¸ë ˆì´ë„ˆ ì¼ì •</h3>
  <div class="trainer-section">
    <button class="arrow" id="prevBtn" aria-label="ì´ì „ íŠ¸ë ˆì´ë„ˆ">â—€</button>
    <div class="trainer-card" id="trainerCard" aria-live="polite"></div>
    <button class="arrow" id="nextBtn" aria-label="ë‹¤ìŒ íŠ¸ë ˆì´ë„ˆ">â–¶</button>
  </div>

  <div class="schedule-section">
    <div id="trainerSubtitle"
       style="text-align:center;font-weight:700;color:#7b5d49;margin-bottom:8px;font-size:1.1rem;">
    ìµ¸ë¹„ ì¼ì •
  </div>
    <div class="weekdays"><div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div></div>
    <div class="calendar" id="calendar"></div>
    <div class="time-select-area">
      <select id="timeSelect" aria-label="ì‹œê°„ ì„ íƒ"><option value="">ì‹œê°„ ì„ íƒ</option></select>
      <button class="reserve-btn" id="reserveBtn" disabled>ì˜ˆì•½í•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- floating buttons -->
<button class="floating-btn floating-notice" id="noticeBtn">ğŸ“¢ ê³µì§€ì‚¬í•­</button>
<button class="floating-btn floating-admin" id="adminBtn">âš™ ê´€ë¦¬ì</button>

<!-- ê³µì§€ì‚¬í•­ ëª¨ë‹¬ -->
<div class="notice-modal" id="noticeModal">
  <div class="notice-content">
    <span class="notice-close" id="noticeClose" role="button" tabindex="0" aria-label="ë‹«ê¸°">âœ•</span>
    <h2>ğŸ“¢ FITë¸”ë¦¬ PT ì„¼í„° ê³µì§€ì‚¬í•­</h2>
    <ul id="noticeList"></ul>
  </div>
</div>

<!-- ê´€ë¦¬ì/íŠ¸ë ˆì´ë„ˆ ëª¨ë‹¬ -->
<div class="admin-modal" id="adminModal">
  <div class="admin-content">
    <span class="admin-close" id="adminClose" role="button" tabindex="0" aria-label="ë‹«ê¸°">âœ•</span>
    <h2 id="panelTitle">âš™ ê´€ë¦¬ì/íŠ¸ë ˆì´ë„ˆ íŒ¨ë„</h2>

    <div class="tab-btns" id="tabBtns">
      <button class="tab-btn" data-tab="reservations">ì˜ˆì•½ê´€ë¦¬</button>
      <button class="tab-btn" data-tab="times">ì‹œê°„ì„¤ì •</button>
      <button class="tab-btn admin-only" data-tab="notices">ê³µì§€ê´€ë¦¬</button>
      <button class="tab-btn admin-only" data-tab="roles">ê¶Œí•œê´€ë¦¬</button>
    </div>

    <!-- ì˜ˆì•½ ê´€ë¦¬ -->
    <div class="tab-content" id="tab-reservations">
  <h3>ğŸ“… ì˜ˆì•½ ëª©ë¡</h3>
  <div id="trainerFilterArea" style="display:none;margin-bottom:10px;text-align:center;">
    <select id="trainerFilter" style="padding:8px 10px;border:2px solid #ffd6a5;border-radius:10px;">
      <option value="">ëª¨ë“  íŠ¸ë ˆì´ë„ˆ ë³´ê¸°</option>
    </select>
  </div>
  <table class="admin-table">
    <thead>
      <tr>
        <th>ê³ ë²ˆ</th><th>ë‹‰ë„¤ì„</th><th>íŠ¸ë ˆì´ë„ˆ</th>
        <th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th>
      </tr>
    </thead>
    <tbody id="adminTable"></tbody>
  </table>
</div>
    <!-- ì‹œê°„ ì„¤ì • -->
    <div class="tab-content" id="tab-times">
      <div id="timesAdminBlock" style="display:none">
        <h3>ğŸ•’ íŠ¸ë ˆì´ë„ˆë³„ ì‹œê°„ ì„¤ì •(ê´€ë¦¬ì)</h3>
        <p style="margin:6px 0 12px;color:#7b5d49">ì²´í¬í•œ ì‹œê°„ë§Œ ìœ ì € ìº˜ë¦°ë”ì— ë…¸ì¶œë©ë‹ˆë‹¤.</p>
        <div id="trainerTimeList"></div>
        <button id="applyTimesAdmin" class="tab-btn" style="margin-top:12px">ì ìš©</button>
      </div>

      <div id="timesTrainerBlock" style="display:none">
        <!-- ë‚´ë¶€ UIëŠ” buildTrainerDayGrid()ì—ì„œ ìƒì„± (ì¤‘ë³µ ID ë°©ì§€) -->
        <div class="time-grid" id="trainerDayGrid"></div>
      </div>
    </div>

    <!-- ê³µì§€ ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) -->
    <div class="tab-content" id="tab-notices">
      <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="newNotice" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;min-width:240px;padding:8px;border:2px solid #ffd6a5;border-radius:10px;">
        <button id="addNotice" class="tab-btn">ì¶”ê°€</button>
      </div>
      <ul id="adminNoticeList" style="margin-top:10px"></ul>
    </div>

    <!-- ê¶Œí•œ ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) -->
    <div class="tab-content" id="tab-roles">
      <h3>ğŸ§‘â€ğŸ’¼ ê¶Œí•œ ê´€ë¦¬</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <input id="roleUserId" placeholder="ê³ ë²ˆ ì…ë ¥" style="padding:8px;width:220px;border:2px solid #ffd6a5;border-radius:10px">
        <input id="roleNickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="padding:8px;width:220px;border:2px solid #ffd6a5;border-radius:10px">
        <select id="roleSelect" style="padding:8px;border:2px solid #ffd6a5;border-radius:10px">
          <option value="member">ì¼ë°˜ ìœ ì €</option>
          <option value="trainer">íŠ¸ë ˆì´ë„ˆ</option>
        </select>
        <button id="applyRole" class="tab-btn">ì ìš©</button>
      </div>
      <table class="admin-table">
        <thead><tr><th>ê³ ë²ˆ</th><th>ë‹‰ë„¤ì„</th><th>ê¶Œí•œ</th></tr></thead>
        <tbody id="roleTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

/* =======================
      Firebase ì„¤ì •
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyCmILB2NGpZmkSByWGjN1ZIBlxwQqRpHHg",
  authDomain: "pttt-dc58e.firebaseapp.com",
  projectId: "pttt-dc58e",
  storageBucket: "pttt-dc58e.appspot.com",
  messagingSenderId: "1015121703137",
  appId: "1:1015121703137:web:b4177af397cc5ed74887a0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =======================
      ì „ì—­ ìƒíƒœ/ìƒìˆ˜
======================= */
const ADMIN_CODE = "admin7312";
const TRAINER_CODE = "trainer6358";

let currentUser = null;         // {id, nick}
let currentRoleForPanel = null; // "admin" | "trainer"
let currentTrainer = 0;
let selectedDate = null;
let bookings = []; // {id, userId, nickname, trainer, date, time, status, createdAt}

const trainers = [
  {name:"ìµ¸ë¹„",photo:"https://i.imgur.com/YomGIwi.jpeg/260x180?text=A",intro:"íšŒì›ë‹˜ ê¸°ë‹¤ë¦¬ëŠ”ì¤‘..ğŸ¥"},
  {name:"ì²­í•˜",photo:"https://i.imgur.com/n2SeItj.png/260x180?text=B",intro:"ë§ ì•ˆ ê±¸ë©´ ìœ íŠœë¸Œ ë³´ëŸ¬ê° ã……ã„±"},
  {name:"ë¯¼ìµ¸",photo:"https://i.imgur.com/0izCNbT.png/260x180?text=C",intro:"ë¯¼íŠ¸ì´ˆì½” ì¢‹ì•„í•˜ì„¸ìš”? ì €ë„ ì¢‹ì•„í•´ìš”.. íšŒì›ë‹˜ì„â¤"},
  {name:"í‘¸ë¥¸í•˜ëŠ˜",photo:"https://i.imgur.com/ZclMIE5.png/260x180?text=D",intro:"ì²´í˜• ë¶„ì„ ê¸°ë°˜ í•˜ì²´ ì „ë¬¸ PTë¡œ íƒ„ë ¥ ìˆëŠ” í™ë¼ì¸ ì™„ì„±! 1ëŒ€1 ë§ì¶¤ ìƒë‹´ìœ¼ë¡œ í™ ì„±ì¥ ë„ì™€ë“œë¦½ë‹ˆë‹¤."},
  {name:"í‚¤ìœ„ë¯¹ìŠ¤",photo:"https://i.imgur.com/mCuwI4l.png/260x180?text=D",intro:"ë‚¨ì ì˜ˆì•½ ì‚¬ì ˆ"},
  {name:"ì± ë¹„",photo:"https://i.imgur.com/t7PqDf4.png/260x180?text=D",intro:"ì—¬ì í™˜ì˜"},
  {name:"ì†¡ì‹¤ìˆ˜",photo:"https://i.imgur.com/NNzElX5.png/260x180?text=D",intro:"-"},
  {name:"ì´ì¬ì„±",photo:"https://i.imgur.com/NNzElX5.png/260x180?text=D",intro:"-"},
  {name:"ì•Œë ‰ì‚°ë“œë¡ ë¹„ì¹˜",photo:"https://i.imgur.com/NNzElX5.png/260x180?text=D",intro:"-"},
  {name:"ì˜ì›",photo:"https://i.imgur.com/NNzElX5.png/260x180?text=D",intro:"-"},
  {name:"ì„¸ìƒì€",photo:"https://i.imgur.com/NNzElX5.png/260x180?text=D",intro:"-"},
  {name:"ì˜¤ì˜íƒ",photo:"https://i.imgur.com/vVtah2J.png/260x180?text=D",intro:"ê·¼ì†ì‹¤ ë§‰ëŠ” ë²•? ì €ë¥¼ í•˜ë£¨ í•œ ë²ˆ ë³´ë©´ ë©ë‹ˆë‹¤"},
  {name:"ë¹ˆì„¼íŠ¸",photo:"https://i.imgur.com/KOqaFQO.png/260x180?text=D",intro:"ìš´ë™ í•˜ì‹œëŠ” ë™ì•ˆ ì§€ë£¨í•˜ì§€ì•Šë‚˜ìš”?ë‹¹ì‹ ì˜ ì§€ë£¨í•¨ì„ ì—†ì• ê³  ì‹¶ë‹¤ë©´ ì €ë¥¼ ê³¨ë¼ì£¼ì„¸ìš” ps íˆ¬ë¨¸ì¹˜í† ì»¤ ì£¼ì˜, ë‚¨ì„± ì•Œë ˆë¥´ê¸° ë³´ìœ , ë¯¸ìŠ¤í„°ë¦¬ ë‚¨"},
  {name:"ì½”ì½”ë³¼",photo:"https://i.imgur.com/UpmL5pw.png/260x180?text=D",intro:"ì €ì¹¼ë¡œë¦¬ ê³ ë‹¨ë°± ì½”ì½”ë³¼ì…ë‹ˆë‹¤(^â–½^)"},
  {name:"ë•ƒì¥",photo:"https://i.imgur.com/SR0eafB.png/260x180?text=D",intro:"ì°ì°"},
  {name:"ì˜¤ìœ ì§„",photo:"https://i.imgur.com/GKwIb6v.png/260x180?text=D",intro:"ì”ì”í•˜ê²Œ ìš´ë™í•˜ì‹¤ ë¶„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘~!"},
  {name:"ìœ¨ì´",photo:"https://i.imgur.com/99iR00n.png/260x180?text=D",intro:"ëˆ„ë‚˜ë‘ ìš´ë™í•˜ë©´ 1ì‹œê°„ë™ì•ˆ ì¦ê±°ìš¸ê±°ì•¼"}
];

const allTimes = Array.from({length:24},(_,i)=>`${String(i).padStart(2,"0")}:00`);
const daysKo = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

/* =======================
      ì—˜ë¦¬ë¨¼íŠ¸
======================= */
const intro = document.getElementById("intro");
const main = document.getElementById("main");
const startBtn = document.getElementById("startBtn");

const trainerCard = document.getElementById("trainerCard");
const trainerTitle = document.getElementById("trainerTitle");
const calendar = document.getElementById("calendar");
const timeSelect = document.getElementById("timeSelect");
const reserveBtn = document.getElementById("reserveBtn");

const noticeBtn = document.getElementById("noticeBtn");
const noticeModal = document.getElementById("noticeModal");
const noticeClose = document.getElementById("noticeClose");
const noticeList = document.getElementById("noticeList");

const adminBtn = document.getElementById("adminBtn");
const adminModal = document.getElementById("adminModal");
const adminClose = document.getElementById("adminClose");
const panelTitle = document.getElementById("panelTitle");
const adminTable = document.getElementById("adminTable");
const tabBtns = document.querySelectorAll(".tab-btn");
const tabReservations = document.getElementById("tab-reservations");
const tabTimes = document.getElementById("tab-times");
const tabNotices = document.getElementById("tab-notices");
const tabRoles = document.getElementById("tab-roles");
const trainerTimeList = document.getElementById("trainerTimeList");
const adminNoticeList = document.getElementById("adminNoticeList");
const roleTable = document.getElementById("roleTable");
const timesAdminBlock = document.getElementById("timesAdminBlock");
const timesTrainerBlock = document.getElementById("timesTrainerBlock");
const trainerDayGrid = document.getElementById("trainerDayGrid");

/* =======================
      ìœ í‹¸
======================= */
function showToast(msg){
  const t=document.createElement("div");
  t.className="toast"; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function getWeekdayKo(yyyymmdd){ // "YYYY-MM-DD"
  const [y,m,d] = yyyymmdd.split("-").map(Number);
  const w = new Date(y, m-1, d).getDay();
  return daysKo[w];
}

function ymd(today){
  const y = today.getFullYear();
  const m = String(today.getMonth()+1).padStart(2,"0");
  const d = String(today.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

/* =======================
      ë¡œê·¸ì¸
======================= */
startBtn.addEventListener("click", async () => {
  const id = document.getElementById("userId").value.trim();
  const nick = document.getElementById("nickname").value.trim();
  if(!id || !nick) return showToast("ê³ ë²ˆê³¼ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");

  currentUser = { id, nick };
  try {
    const userRef = doc(db, "users", id);
    const userSnap = await getDoc(userRef);

    // âœ… ìœ ì € ë¬¸ì„œê°€ ì—†ì„ ë•Œë§Œ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
    if (!userSnap.exists()) {
      await setDoc(userRef, {
        nickname: nick,
        role: "member",
        isAdminVisible: false,
        updatedAt: serverTimestamp()
      });
    } else {
      // âœ… ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë‹‰ë„¤ì„ë§Œ ì—…ë°ì´íŠ¸ (role/isAdminVisible ìœ ì§€)
      await setDoc(userRef, {
        nickname: nick,
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    // ğŸ”¹ Firestoreì—ì„œ isAdminVisible ì—¬ë¶€ í™•ì¸
    const updatedSnap = await getDoc(userRef);
    let isVisible = false;
    if (updatedSnap.exists()) {
      const data = updatedSnap.data();
      isVisible = !!data.isAdminVisible; // trueì¼ ë•Œë§Œ í‘œì‹œ
    }

    // ğŸ”¹ ë²„íŠ¼ í‘œì‹œ ì„¤ì •
    const adminBtn = document.getElementById("adminBtn");
    adminBtn.style.display = isVisible ? "block" : "none";

    // ğŸ”¹ ì¸íŠ¸ë¡œ â†’ ë©”ì¸ í™”ë©´ ì „í™˜
    intro.style.opacity = "0";
    intro.setAttribute("aria-hidden", "true");
    setTimeout(() => {
      intro.style.display = "none";
      main.style.display = "block";
      main.setAttribute("aria-hidden", "false");
    }, 300);

    await fetchBookings();
    await loadNoticesForUsers();
    showTrainer(currentTrainer);
  } catch(e) {
    console.error(e);
    showToast("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});
/* =======================
      íŠ¸ë ˆì´ë„ˆ/ìº˜ë¦°ë”
======================= */
document.getElementById("prevBtn").addEventListener("click", () => {
  currentTrainer = (currentTrainer - 1 + trainers.length) % trainers.length;
  showTrainer(currentTrainer);
});
document.getElementById("nextBtn").addEventListener("click", () => {
  currentTrainer = (currentTrainer + 1) % trainers.length;
  showTrainer(currentTrainer);
});

function showTrainer(i){
  const t = trainers[i];
  trainerCard.innerHTML = `<img src="${t.photo}" alt="${t.name} ì‚¬ì§„"><h3>${t.name}</h3><p>${t.intro}</p>`;
  trainerTitle.textContent = `${t.name} ì¼ì •`;
  document.getElementById("trainerSubtitle").textContent = `${t.name} ì¼ì •`; // âœ… ì¶”ê°€
  renderCalendar();
}

function renderCalendar(){
  calendar.innerHTML = "";
  const now = new Date();
  const todayZero = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const y = now.getFullYear(), m = now.getMonth();
  const fd = new Date(y, m, 1), ld = new Date(y, m + 1, 0);

  // âœ… ì´ë²ˆ ì£¼ì˜ ì‹œì‘(ì¼ìš”ì¼)ê³¼ ë(í† ìš”ì¼) ê³„ì‚°
  const startOfWeek = new Date(todayZero);
  startOfWeek.setDate(todayZero.getDate() - todayZero.getDay());
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);

  // ë¹ˆì¹¸ ì±„ìš°ê¸°
  for(let i=0;i<fd.getDay();i++){
    const sp=document.createElement("div");
    calendar.appendChild(sp);
  }

  for(let d=1; d<=ld.getDate(); d++){
    const dateObj = new Date(y, m, d);
    const dateStr = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const dayEl = document.createElement("div");
    dayEl.className = "day";
    dayEl.textContent = d;

    // âœ… ì´ì „ ë‚ ì§œ ë° ì´ë²ˆ ì£¼ ë²”ìœ„ ë°–ì€ ë¹„í™œì„±í™”
    if(dateObj < todayZero || dateObj < startOfWeek || dateObj > endOfWeek){
      dayEl.classList.add("disabled");
    }

    const hasBooking = bookings.some(b=>b.trainer===trainers[currentTrainer].name && b.date===dateStr);
    if(hasBooking) dayEl.classList.add("booked");

    dayEl.addEventListener("click", () => {
      if(dayEl.classList.contains("disabled")) return showToast("ì´ë²ˆ ì£¼ë§Œ ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
      document.querySelectorAll(".day").forEach(c=>c.classList.remove("selected"));
      dayEl.classList.add("selected");
      selectedDate = dateStr;
      updateTimeOptions();
      showMyReservationModal(dateStr);
    });
    calendar.appendChild(dayEl);
  }
}

  async function getTimesForTrainerAndDate(trainerName, yyyymmdd){
  const weekday = getWeekdayKo(yyyymmdd); // "ì›”"~"ì¼"
  
  // 1) íŠ¸ë ˆì´ë„ˆ ê°œë³„ ìŠ¤ì¼€ì¤„
  try{
    const docSnap = await getDoc(doc(db,"trainerSchedule",trainerName));
    if(docSnap.exists()){
      const data = docSnap.data();
      if(Array.isArray(data[weekday]) && data[weekday].length) return data[weekday];
    }
  }catch(e){ console.warn("trainerSchedule read error", e); }

  // 2) ê´€ë¦¬ì ì „ì²´ ì„¤ì •
  try{
    const setSnap = await getDoc(doc(db,"settings","trainerTimes"));
    if(setSnap.exists()){
      const arr = setSnap.data()[trainerName];
      if(Array.isArray(arr) && arr.length) return arr;
    }
  }catch(e){ console.warn("settings read error", e); }

  // âœ… 3) ê¸°ë³¸ê°’ì„ ì—†ì• ê³ , ë¹„ì–´ ìˆëŠ” ë°°ì—´ë¡œ ì²˜ë¦¬
  // ì¦‰, ê´€ë¦¬ì ì„¤ì • ì—†ìœ¼ë©´ ì‹œê°„ ì„ íƒì´ ë¹„ì–´ ìˆìŒ
  return [];
}
async function updateTimeOptions(){
  timeSelect.innerHTML = '<option value="">ì‹œê°„ ì„ íƒ</option>';
  reserveBtn.disabled = true;
  if(!selectedDate) return;

  const t = trainers[currentTrainer];
  const availableTimes = await getTimesForTrainerAndDate(t.name, selectedDate);

  if (availableTimes.length === 0) {
    const opt = document.createElement("option");
    opt.textContent = "âŒ í˜„ì¬ ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.";
    opt.disabled = true;
    timeSelect.appendChild(opt);
    return;
  }

  const bookedTimes = bookings
    .filter(b=>b.trainer===t.name && b.date===selectedDate)
    .map(b=>b.time);

  let hasAvail = false;
  availableTimes.forEach(time=>{
    const opt=document.createElement("option");
    const isBooked = bookedTimes.includes(time);
    opt.value=time;
    opt.textContent = isBooked ? `${time} (ì˜ˆì•½ë¨)` : time;
    opt.disabled = isBooked;
    if(!isBooked) hasAvail = true;
    timeSelect.appendChild(opt);
  });
  reserveBtn.disabled = !hasAvail;
}
/* ì˜ˆì•½ ìƒì„± */
reserveBtn.addEventListener("click", async ()=>{
  if(!currentUser) return showToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
  if(!selectedDate) return showToast("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”!");
  const time = timeSelect.value;
  if(!time) return showToast("ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”!");

  // ğŸ”¹ í˜„ì¬ ì‹œê°„ê³¼ ë¹„êµ (ì˜ˆì•½ ì‹œê°„ 30ë¶„ ì „ì´ë©´ ì˜ˆì•½ ë¶ˆê°€)
  const now = new Date();
  const [h, m] = time.split(":").map(Number);
  const reserveDate = new Date(selectedDate);
  reserveDate.setHours(h, m, 0, 0);

  const diffMin = (reserveDate - now) / 60000; // ë¶„ ë‹¨ìœ„ ì°¨ì´
  if(diffMin <= 30) {
    return showToast("ğŸš« ì˜ˆì•½ ì‹œê°„ 30ë¶„ ì „ì—ëŠ” ì˜ˆì•½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤!");
  }

  const t = trainers[currentTrainer];
  const dup = bookings.find(b=>b.trainer===t.name && b.date===selectedDate && b.time===time);
  if(dup) return showToast("ì´ë¯¸ ì˜ˆì•½ëœ ì‹œê°„ì…ë‹ˆë‹¤!");

  try{
    await addDoc(collection(db,"reservations"),{
      userId: currentUser.id,
      nickname: currentUser.nick,
      trainer: t.name,
      date: selectedDate,
      time,
      status: "reserved",
      createdAt: serverTimestamp()
    });
    showToast(`${currentUser.nick}ë‹˜ì˜ ${t.name} ${selectedDate} ${time} ì˜ˆì•½ ì™„ë£Œ!`);
    await fetchBookings();
    await updateTimeOptions();
  }catch(e){
    console.error(e);
    showToast("ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

/* =======================
      ì˜ˆì•½ ë°ì´í„° ë¡œë”©
======================= */
async function fetchBookings(){
  bookings = [];
  try{
    const q = await getDocs(collection(db,"reservations"));
    q.forEach(s=>{
      const d=s.data();
      bookings.push({ id:s.id, ...d });
    });
    renderCalendar();
  }catch(e){
    console.error(e);
    showToast("ì˜ˆì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}

/* =======================
      ê³µì§€ì‚¬í•­ (ìœ ì € ë³´ê¸°)
======================= */
noticeBtn.addEventListener("click", async ()=>{
  noticeModal.style.display="flex";
  await loadNoticesForUsers();
});
noticeClose.addEventListener("click", ()=> noticeModal.style.display="none");
noticeClose.addEventListener("keydown", (e)=>{ if(e.key==="Enter") noticeModal.style.display="none"; });

async function loadNoticesForUsers(){
  noticeList.innerHTML="";
  try{
    const q=await getDocs(collection(db,"notices"));
    const arr = []; 
    q.forEach(s=>arr.push({id:s.id, ...s.data()}));
    // createdAtì´ serverTimestampì¸ ê²½ìš° nullì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „ ì •ë ¬
    arr.sort((a,b)=>{
      const as = a.createdAt?.seconds ?? 0;
      const bs = b.createdAt?.seconds ?? 0;
      return bs - as;
    });
    if(arr.length===0){
      const li=document.createElement("li");
      li.textContent="ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
      noticeList.appendChild(li);
    }else{
      arr.forEach(n=>{
        const li=document.createElement("li");
        li.textContent = n.message;
        noticeList.appendChild(li);
      });
    }
  }catch(e){
    console.error(e);
    showToast("ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}

/* =======================
      íŒ¨ë„ ì—´ê¸°(ê´€ë¦¬ì/íŠ¸ë ˆì´ë„ˆ)
======================= */
adminBtn.addEventListener("click", async ()=>{
  if(!currentUser) return showToast("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!");
  const code = prompt("ê´€ë¦¬ì ë˜ëŠ” íŠ¸ë ˆì´ë„ˆ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if(code===ADMIN_CODE){
    currentRoleForPanel = "admin";
    openPanel("admin");
  }else if(code===TRAINER_CODE){
    currentRoleForPanel = "trainer";
    openPanel("trainer");
  }else{
    showToast("ğŸš« ì˜ëª»ëœ ì½”ë“œì…ë‹ˆë‹¤.");
  }
});

adminClose.addEventListener("click", ()=> adminModal.style.display="none");

function openPanel(role){
  adminModal.style.display="flex";
  // íƒ­ ì´ˆê¸°í™”
  document.querySelectorAll(".tab-content").forEach(el=>el.style.display="none");
  tabBtns.forEach(b=>b.classList.remove("active"));
  // admin-only ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
  document.querySelectorAll(".admin-only").forEach(el=>{
    el.style.display = (role==="admin") ? "" : "none";
  });

  if(role==="admin"){
    panelTitle.textContent = "âš™ ê´€ë¦¬ì íŒ¨ë„";
    showTab("reservations");
    loadReservationsTable();
    timesAdminBlock.style.display="block";
    timesTrainerBlock.style.display="none";
    loadTimeSettingsAdminUI();
    loadAdminNotices();
    loadRoles();
  }else{
    panelTitle.textContent = "ğŸ§‘â€ğŸ« íŠ¸ë ˆì´ë„ˆ íŒ¨ë„";
    showTab("reservations");
    loadReservationsTable();
    timesAdminBlock.style.display="none";
    timesTrainerBlock.style.display="block";
    buildTrainerDayGrid();
  }
}

// íƒ­ ë²„íŠ¼ ë™ì‘
tabBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const tab = btn.getAttribute("data-tab");
    if(currentRoleForPanel==="trainer" && (tab==="notices"||tab==="roles")) return;
    showTab(tab);
    if(tab==="reservations") loadReservationsTable();
    if(tab==="times"){
      if(currentRoleForPanel==="admin"){ loadTimeSettingsAdminUI(); }
      else { buildTrainerDayGrid(); }
    }
    if(tab==="notices" && currentRoleForPanel==="admin") loadAdminNotices();
    if(tab==="roles" && currentRoleForPanel==="admin") loadRoles();
  });
});

function showTab(tab){
  document.querySelectorAll(".tab-content").forEach(el=>el.style.display="none");
  document.getElementById(`tab-${tab}`).style.display="block";
  tabBtns.forEach(b=>b.classList.remove("active"));
  const tbtn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  if(tbtn) tbtn.classList.add("active");
}

/* =======================
      ì˜ˆì•½ í…Œì´ë¸”(ê³µìš©)
======================= */
async function loadReservationsTable(){
  adminTable.innerHTML="";
  await fetchBookings();
  const role = currentRoleForPanel;

  const trainerFilterArea = document.getElementById("trainerFilterArea");
  const trainerFilter = document.getElementById("trainerFilter");

  // âœ… íŠ¸ë ˆì´ë„ˆ íŒ¨ë„ì¼ ë•Œë§Œ í‘œì‹œ
  if(role==="trainer"){
    trainerFilterArea.style.display="block";

    // âœ… ì˜µì…˜ ìë™ ì¶”ê°€ (ìµœì´ˆ í•œ ë²ˆë§Œ)
    if(trainerFilter.options.length === 1){
      trainers.forEach(t=>{
        const opt=document.createElement("option");
        opt.value=t.name;
        opt.textContent=t.name;
        trainerFilter.appendChild(opt);
      });
    }
  }else{
    trainerFilterArea.style.display="none";
  }

  const filterValue = trainerFilter ? trainerFilter.value : "";

  // âœ… í•„í„° ì ìš©
  let filtered = bookings;
  if(role==="trainer" && filterValue){
    filtered = bookings.filter(b=>b.trainer===filterValue);
  }

  // ë‚ ì§œ/ì‹œê°„ ìµœì‹ ìˆœ ì •ë ¬
  filtered.sort((a,b)=>{
    const ad=new Date(a.date), bd=new Date(b.date);
    if(ad.getTime()===bd.getTime()) return a.time.localeCompare(b.time);
    return bd.getTime()-ad.getTime();
  });

  if(filtered.length===0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
    adminTable.appendChild(tr);
    return;
  }

  filtered.forEach(b=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${b.userId}</td>
      <td>${b.nickname}</td>
      <td>${b.trainer}</td>
      <td>${b.date}</td>
      <td>${b.time}</td>
      <td>${b.status}</td>
      <td>
        <button data-id="${b.id}" class="btn-cancel"
          style="padding:4px 8px;border:none;border-radius:8px;background:#ffb4a2;cursor:pointer">
          ì·¨ì†Œ
        </button>
      </td>
    `;
    adminTable.appendChild(tr);
  });

  adminTable.querySelectorAll(".btn-cancel").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-id");
      if(!confirm("ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      try{
        await deleteDoc(doc(db,"reservations",id));
        showToast("ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        await loadReservationsTable();
        await fetchBookings();
        await updateTimeOptions();
      }catch(e){
        console.error(e);
        showToast("ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });

  // âœ… í•„í„° ë³€ê²½ ì´ë²¤íŠ¸ â†’ ì‹¤ì‹œê°„ ê°±ì‹ 
if(trainerFilter){
  trainerFilter.onchange = ()=> loadReservationsTable();
  }
}
/* =======================
      ì‹œê°„ ì„¤ì • - ê´€ë¦¬ì
======================= */
async function loadTimeSettingsAdminUI(){
  trainerTimeList.innerHTML="";
  let data = {};
  try{
    const snap = await getDoc(doc(db,"settings","trainerTimes"));
    data = snap.exists()? snap.data() : {};
  }catch(e){ console.warn(e); }

  trainers.forEach(t=>{
    const wrap=document.createElement("div");
    wrap.style.cssText="border:1px solid #ffd6a5;border-radius:12px;padding:10px 12px;margin:10px 0;background:#fff";
    wrap.dataset.trainer = t.name;

    const title = document.createElement("h4");
    title.style.cssText="margin:6px 0 8px;color:#b45309";
    title.textContent = t.name;
    wrap.appendChild(title);

    const box=document.createElement("div");
    box.style.cssText="display:flex;flex-wrap:wrap;gap:8px";
    const selectedArr = Array.isArray(data[t.name]) ? data[t.name] : [];
    allTimes.forEach(tm=>{
      const label = document.createElement("label");
      label.className="time-chip";
      const checked = selectedArr.includes(tm) ? "checked" : "";
      label.innerHTML = `<input type="checkbox" value="${tm}" ${checked}/> ${tm}`;
      box.appendChild(label);
    });
    wrap.appendChild(box);
    trainerTimeList.appendChild(wrap);
  });
}

document.getElementById("applyTimesAdmin").addEventListener("click", async ()=>{
  const result = {};
  // childrenìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ìˆœíšŒ ("> div" ê°™ì€ ë¶€ì •í™•í•œ ì„ íƒì ì‚¬ìš© ê¸ˆì§€)
  Array.from(trainerTimeList.children).forEach(container=>{
    const name = container.dataset.trainer || container.querySelector("h4")?.textContent?.trim();
    if(!name) return;
    const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
    result[name] = selected;
  });
  try{
    await setDoc(doc(db,"settings","trainerTimes"), result);
    showToast("âœ… (ê´€ë¦¬ì) ì‹œê°„ ì„¤ì • ì €ì¥ë¨");
    await updateTimeOptions();
  }catch(e){
    console.error(e);
    showToast("ì‹œê°„ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

/* =======================
      ì‹œê°„ ì„¤ì • - íŠ¸ë ˆì´ë„ˆ
======================= */
function buildTrainerDayGrid(){
  const area = trainerDayGrid;
  area.innerHTML = `
    <h3>ğŸ•’ ë‚˜ì˜ ì‹œê°„ ì„¤ì •(íŠ¸ë ˆì´ë„ˆ)</h3>
    <p style="margin:6px 0 12px;color:#7b5d49">íŠ¸ë ˆì´ë„ˆì™€ ìš”ì¼ì„ ì„ íƒ í›„ ì‹œê°„ëŒ€ë¥¼ ì²´í¬í•˜ì„¸ìš”.</p>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <select id="trainerSelect" style="padding:10px;border:2px solid #ffd6a5;border-radius:10px">
        <option value="">íŠ¸ë ˆì´ë„ˆ ì„ íƒ</option>
        ${trainers.map(t=>`<option value="${t.name}">${t.name}</option>`).join("")}
      </select>
      <select id="daySelect" style="padding:10px;border:2px solid #ffd6a5;border-radius:10px">
        <option value="">ìš”ì¼ ì„ íƒ</option>
        ${daysKo.map(d=>`<option value="${d}">${d}</option>`).join("")}
      </select>
    </div>

    <!-- âœ… ì„¸ë¡œ ì •ë ¬ ì‹œê°„ì¹© -->
    <div id="timeGrid" style="
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      margin-top:8px;
    "></div>
  `;

  const trainerSelect = area.querySelector("#trainerSelect");
  const daySelect = area.querySelector("#daySelect");
  const timeGrid = area.querySelector("#timeGrid");

  const renderTimes = async ()=>{
    timeGrid.innerHTML = "";
    const tName = trainerSelect.value;
    const dName = daySelect.value;
    if(!tName || !dName) return;

    // ì‹œê°„ì¹© ì„¸ë¡œë¡œ ì¶”ê°€
    allTimes.forEach(tm=>{
      const label=document.createElement("label");
      label.className="time-chip";
      label.style.width = "100px";
      label.innerHTML = `<input type="checkbox" value="${tm}"> ${tm}`;
      timeGrid.appendChild(label);
    });

    // âœ… ë§¨ ì•„ë˜ì— ì ìš© ë²„íŠ¼ ì¶”ê°€
    const btnWrap = document.createElement("div");
    btnWrap.style.cssText = "text-align:center;margin-top:14px;";
    btnWrap.innerHTML = `
      <button id="trainerTimesApply"
        class="tab-btn"
        style="padding:10px 24px;font-weight:700;border-radius:10px;background:var(--grad);color:#fff;">
        ì ìš©
      </button>
    `;
    timeGrid.appendChild(btnWrap);

    // ê¸°ì¡´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    const snap = await getDoc(doc(db,"trainerSchedule", tName));
    if(snap.exists()){
      const data = snap.data();
      const arr = Array.isArray(data[dName]) ? data[dName] : [];
      timeGrid.querySelectorAll("input").forEach(cb=>{
        cb.checked = arr.includes(cb.value);
      });
    }

    // ì ìš© ì´ë²¤íŠ¸
    const applyBtn = btnWrap.querySelector("#trainerTimesApply");
    applyBtn.onclick = async ()=>{
      const checkedTimes = Array.from(timeGrid.querySelectorAll("input:checked")).map(i=>i.value);
      const ref = doc(db,"trainerSchedule", tName);
      const snap = await getDoc(ref);
      const data = snap.exists()? snap.data() : {};
      data[dName] = checkedTimes;
      await setDoc(ref, data, { merge:true });
      showToast(`âœ… ${tName}ì˜ ${dName} ìš”ì¼ ì‹œê°„ ì €ì¥ ì™„ë£Œ`);
    };
  };

  trainerSelect.onchange = renderTimes;
  daySelect.onchange = renderTimes;
}

/* =======================
      ê³µì§€(ê´€ë¦¬ì)
======================= */
async function loadAdminNotices(){
  adminNoticeList.innerHTML="";
  try{
    const q=await getDocs(collection(db,"notices"));
    const arr=[]; q.forEach(s=>arr.push({id:s.id, ...s.data()}));
    arr.sort((a,b)=> (b.createdAt?.seconds??0) - (a.createdAt?.seconds??0));
    arr.forEach(n=>{
      const li=document.createElement("li");
      li.style.cssText="background:#fff;border:1px solid #ffd6a5;border-radius:12px;padding:10px 12px;margin:8px 0;display:flex;justify-content:space-between;align-items:center";
      li.innerHTML = `<span>${n.message}</span>
        <button data-id="${n.id}" class="btn-del" style="border:none;border-radius:8px;padding:6px 10px;background:#ffb4a2;cursor:pointer">ì‚­ì œ</button>`;
      adminNoticeList.appendChild(li);
    });
    adminNoticeList.querySelectorAll(".btn-del").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        if(!confirm("í•´ë‹¹ ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
        try{
          await deleteDoc(doc(db,"notices",id));
          await loadAdminNotices();
          showToast("ğŸ—‘ï¸ ê³µì§€ ì‚­ì œë¨");
          await loadNoticesForUsers();
        }catch(e){
          console.error(e);
          showToast("ê³µì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    });
  }catch(e){
    console.error(e);
    showToast("ê³µì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}

document.getElementById("addNotice").addEventListener("click", async ()=>{
  const msg = (document.getElementById("newNotice").value || "").trim();
  if(!msg) return showToast("ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
  try{
    await addDoc(collection(db,"notices"),{ message:msg, createdAt: serverTimestamp() });
    document.getElementById("newNotice").value="";
    showToast("ğŸ“¢ ê³µì§€ ì¶”ê°€ë¨");
    await loadAdminNotices();
    await loadNoticesForUsers();
  }catch(e){
    console.error(e);
    showToast("ê³µì§€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

/* =======================
      ê¶Œí•œ ê´€ë¦¬(ê´€ë¦¬ì)
======================= */
async function loadRoles(){
  roleTable.innerHTML="";
  try{
    const q=await getDocs(collection(db,"users"));
    const arr=[]; q.forEach(s=>arr.push({id:s.id, ...s.data()}));
    arr.sort((a,b)=> (b.updatedAt?.seconds??0)-(a.updatedAt?.seconds??0));
    if(arr.length===0){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="3">ë“±ë¡ëœ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td>`;
      roleTable.appendChild(tr);
      return;
    }
    arr.forEach(u=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${u.id}</td><td>${u.nickname||""}</td><td>${u.role||"member"}</td>`;
      roleTable.appendChild(tr);
    });
  }catch(e){
    console.error(e);
    showToast("ê¶Œí•œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}
document.getElementById("applyRole").addEventListener("click", async ()=>{
  const id = document.getElementById("roleUserId").value.trim();
  const nick = document.getElementById("roleNickname").value.trim();
  const role = document.getElementById("roleSelect").value;
  if(!id || !nick) return showToast("ê³ ë²ˆê³¼ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");

  try{
    await setDoc(doc(db,"users",id),{
      nickname:nick,
      role,
      // âœ… íŠ¸ë ˆì´ë„ˆì¼ ê²½ìš° ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ ìë™ í™œì„±í™”
      isAdminVisible: role === "trainer",
      updatedAt: serverTimestamp()
    }, { merge:true });

    showToast(`âœ… ${nick}ë‹˜ì„ ${role==="trainer"?"íŠ¸ë ˆì´ë„ˆ":"ì¼ë°˜ ìœ ì €"}ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`);
    await loadRoles();
  }catch(e){
    console.error(e);
    showToast("ê¶Œí•œ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});
/* =======================
      ì‹œì‘
======================= */
function init(){ /* ë¡œê·¸ì¸ í›„ showTrainer í˜¸ì¶œë¨ */ }
init();
  /* =======================
      ë‚´ ì˜ˆì•½ ë³´ê¸° ëª¨ë‹¬
======================= */

// ëª¨ë‹¬ HTML ì¶”ê°€
const myModal = document.createElement("div");
myModal.id = "myReservationModal";
myModal.style.cssText = `
  position:fixed; inset:0;
  background:rgba(0,0,0,0.5);
  display:none; align-items:center; justify-content:center;
  z-index:4000;
`;
myModal.innerHTML = `
  <div id="myModalContent" style="
    background:#fffaf3; border-radius:16px; padding:30px 40px;
    max-width:420px; width:90%; text-align:center;
    box-shadow:0 10px 25px rgba(0,0,0,0.3);
    animation:fadePop .4s ease;">
    <h3 style="margin-top:0;color:#b45309">ğŸ“… ë‚˜ì˜ ì˜ˆì•½ ì •ë³´</h3>
    <div id="myReservationList" style="margin-top:12px;"></div>
    <p style="margin-top:20px;font-size:14px;color:#7b5d49;">(ì•„ë¬´ í‚¤ë‚˜ í´ë¦­ ì‹œ ë‹«í™ë‹ˆë‹¤)</p>
  </div>
`;
document.body.appendChild(myModal);

// ë‹«ê¸° ì´ë²¤íŠ¸
myModal.addEventListener("click", ()=> myModal.style.display="none");
document.addEventListener("keydown", ()=> myModal.style.display="none");

/* âœ… ë‚ ì§œ í´ë¦­ ì‹œ ë‚´ ì˜ˆì•½ ëª¨ë‹¬ ë„ìš°ê¸° */
async function showMyReservationModal(dateStr){
  if(!currentUser) return showToast("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!");
  const listBox = document.getElementById("myReservationList");
  listBox.innerHTML = "â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  myModal.style.display = "flex";

  try{
    const q = await getDocs(collection(db,"reservations"));
    const arr = [];
    q.forEach(s=>{
      const d = s.data();
      if(d.userId === currentUser.id && d.date === dateStr) arr.push(d);
    });

    listBox.innerHTML = "";
    if(arr.length === 0){
      listBox.innerHTML = `<p style="font-weight:600;color:#7b5d49;">ì‹ ì²­í•œ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
      return;
    }

    arr.forEach(r=>{
      const div=document.createElement("div");
      div.style.cssText=`
        border:1px solid #ffd6a5;
        background:#fff; border-radius:12px;
        padding:10px 14px; margin:8px 0;
        box-shadow:0 2px 8px rgba(249,115,22,0.08);
      `;
      div.innerHTML = `
        <p style="margin:4px 0;"><b>íŠ¸ë ˆì´ë„ˆ:</b> ${r.trainer}</p>
        <p style="margin:4px 0;"><b>ì‹œê°„:</b> ${r.time}</p>
        <p style="margin:4px 0;"><b>ìƒíƒœ:</b> ${r.status}</p>
      `;
      listBox.appendChild(div);
    });
  }catch(e){
    console.error(e);
    listBox.innerHTML = `<p style="color:red;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
  }
}
</script>
</body>
</html>















