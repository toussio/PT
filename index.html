<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PT 트레이너 예약 시스템</title>
<style>
:root{
  --bg:#FFDEB3;--card:#FFF3E0;--accent:#f97316;
  --grad:linear-gradient(135deg,#ffb77a,#f97316,#ea580c);
  --ink:#2b1d12;--muted:#5c4033;--disabled:#bfa89c;
}
body{margin:0;font-family:"Pretendard",sans-serif;background:var(--bg);color:var(--ink);overflow-x:hidden;}
/* 인트로 */
.intro-overlay{position:fixed;inset:0;background:url('https://images.unsplash.com/photo-1558611848-73f7eb4001a1?auto=format&fit=crop&w=1400&q=80') center/cover no-repeat;
display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;text-align:center;color:#fff;backdrop-filter:blur(6px);}
.intro-bg{position:absolute;inset:0;background:rgba(0,0,0,0.4);}
.intro-content{position:relative;z-index:2;max-width:800px;background:rgba(255,243,224,0.9);
padding:40px 30px;border-radius:20px;box-shadow:0 0 20px rgba(249,115,22,0.4);color:var(--ink);}
.intro-content h1{font-size:2rem;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.intro-controls{display:flex;flex-direction:column;gap:10px;align-items:center;}
.intro-controls input{padding:10px 14px;border-radius:10px;border:2px solid #ffd6a5;width:70%;font-size:15px;}
.intro-controls button{background:var(--grad);color:#fff;border:none;padding:10px 24px;border-radius:12px;font-weight:600;cursor:pointer;
box-shadow:0 0 10px rgba(249,115,22,.4);transition:.3s;}
.intro-controls button:hover{transform:translateY(-3px);box-shadow:0 0 18px rgba(249,115,22,.6);}

/* floating buttons */
.floating-btn{position:fixed;border:none;border-radius:50px;padding:12px 20px;font-weight:700;color:white;cursor:pointer;background:var(--grad);
box-shadow:0 4px 14px rgba(249,115,22,0.3);z-index:1500;transition:all .3s ease;}
.floating-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(249,115,22,0.5);}
.floating-notice{top:20px;right:20px;}
.floating-admin{bottom:20px;right:20px;}

/* 공지/관리자 모달 */
.notice-modal,.admin-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:3000;}
.notice-content,.admin-content{background:#fffaf3;border-radius:16px;padding:30px 40px;max-width:1000px;width:92%;box-shadow:0 10px 25px rgba(0,0,0,0.3);animation:fadePop .5s ease;}
 /* ✅ 스크롤 추가 */
  max-height:80vh;
  overflow-y:auto;
}
.notice-content h2,.admin-content h2{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:0;text-align:center;}
.notice-content ul{list-style:none;padding:0;margin:10px 0;}
.notice-content li{background:rgba(255,243,224,0.8);border-left:4px solid var(--accent);padding:12px 16px;border-radius:10px;margin:8px 0;
box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.notice-close,.admin-close{float:right;font-weight:700;color:var(--accent);cursor:pointer;font-size:18px;}

/* 관리자 탭 */
.tab-btns{display:flex;gap:10px;justify-content:center;margin-bottom:15px;flex-wrap:wrap}
.tab-btn{padding:8px 16px;border:none;border-radius:8px;background:#ffd6a5;font-weight:700;cursor:pointer;}
.tab-btn.active{background:var(--grad);color:white;}
.tab-content{display:none;}
.admin-table{width:100%;border-collapse:collapse;margin-top:10px}
.admin-table th,.admin-table td{border:1px solid #ffd6a5;padding:8px;text-align:center;}

/* 메인 예약 섹션 */
.main{display:none;padding:40px 20px 80px;animation:fadeInMain 1s ease;}
h2.title{text-align:center;font-size:1.8rem;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px;}
#trainerTitle{text-align:center;font-size:1.1rem;color:var(--muted);margin-bottom:16px;}
.trainer-section{display:flex;justify-content:center;align-items:center;gap:30px;margin-bottom:16px;}
.arrow{background:var(--grad);border:none;border-radius:50%;width:55px;height:55px;display:flex;align-items:center;justify-content:center;
cursor:pointer;transition:.3s;box-shadow:0 0 10px rgba(249,115,22,.3);}
.arrow:hover{transform:scale(1.08);box-shadow:0 0 18px rgba(249,115,22,.6);}
.trainer-card{width:280px;border-radius:20px;background:var(--card);box-shadow:0 4px 10px rgba(0,0,0,.1);
text-align:center;overflow:hidden;transition:.3s;}
.trainer-card img{width:100%;height:180px;object-fit:cover;}
.trainer-card h3{margin:10px 0 4px;color:var(--accent);}
.trainer-card p{margin:0;color:var(--muted);}
.schedule-section{max-width:820px;margin:0 auto;background:var(--card);border-radius:20px;padding:24px 20px;box-shadow:0 0 20px rgba(0,0,0,.08);}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-weight:700;color:var(--muted);margin:0 0 6px;}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:6px;padding-bottom:10px;}
.day{text-align:center;padding:10px 0;border-radius:10px;background:rgba(255,255,255,0.78);cursor:pointer;transition:.25s;font-size:14px;min-height:55px;
display:flex;align-items:center;justify-content:center;font-weight:600;}
.day.booked{background:var(--grad);color:#fff;}
.day.disabled{opacity:.4;cursor:not-allowed;}
.day:hover:not(.disabled):not(.booked){background:rgba(249,115,22,.25);transform:scale(1.05);}
.day.selected{outline:2px solid var(--accent);}
.time-select-area{margin-top:18px;display:flex;flex-direction:column;align-items:center;gap:14px;}
.time-select-area select{width:85%;background:#fffaf3;border:2px solid #ffd6a5;border-radius:20px;padding:14px 16px;font-size:15px;font-weight:600;color:var(--ink);}
button.reserve-btn{width:85%;background:var(--grad);color:#fff;border:none;border-radius:24px;padding:16px 18px;font-size:17px;font-weight:700;cursor:pointer;}
button.reserve-btn:disabled{opacity:.6;cursor:not-allowed}

/* 트레이너 시간설정: 요일 세로표 */
.day-column{border:1px solid #ffd6a5;border-radius:12px;padding:10px;background:#fffaf3;min-width:150px}
.day-column h4{margin:6px 0 10px;color:#b45309}
.time-chip{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid #ffd6a5;border-radius:10px;padding:6px 8px;margin:4px 0;}
.time-grid{display:flex;gap:12px;flex-wrap:wrap}

/* 토스트 */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:#fff8ee;color:var(--ink);border:2px solid #ffd6a5;border-radius:14px;
padding:12px 24px;font-weight:600;font-size:15px;box-shadow:0 4px 15px rgba(249,115,22,0.2);animation:fadeInOut 3s ease forwards;}
@keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,20px);}10%,90%{opacity:1;transform:translate(-50%,0);}100%{opacity:0;transform:translate(-50%,20px);}}
@keyframes fadeInMain{from{opacity:0}to{opacity:1}}
@keyframes fadePop{from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>

<!-- 인트로 -->
<div class="intro-overlay" id="intro">
  <div class="intro-bg"></div>
  <div class="intro-content">
    <h1>🏋️‍♀️ 작두 PT 센터</h1>
    <p>당신의 몸을 디자인하는 곳 — 최고의 트레이너들과 함께하세요.</p>
    <div class="intro-controls">
      <input id="userId" placeholder="고번 입력" />
      <input id="nickname" placeholder="닉네임 입력" />
      <button id="startBtn">시작하기</button>
    </div>
  </div>
</div>

<!-- 메인 -->
<div class="main" id="main">
  <h2 class="title">트레이너 예약 시스템</h2>
  <h3 id="trainerTitle">트레이너 일정</h3>
  <div class="trainer-section">
    <button class="arrow" id="prevBtn">◀</button>
    <div class="trainer-card" id="trainerCard"></div>
    <button class="arrow" id="nextBtn">▶</button>
  </div>
  <div class="schedule-section">
    <div class="weekdays"><div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div></div>
    <div class="calendar" id="calendar"></div>
    <div class="time-select-area">
      <select id="timeSelect"><option value="">시간 선택</option></select>
      <button class="reserve-btn" id="reserveBtn" disabled>예약하기</button>
    </div>
  </div>
</div>

<!-- floating buttons -->
<button class="floating-btn floating-notice" id="noticeBtn">📢 공지사항</button>
<button class="floating-btn floating-admin" id="adminBtn">⚙ 관리자</button>

<!-- 공지사항 모달 -->
<div class="notice-modal" id="noticeModal">
  <div class="notice-content">
    <span class="notice-close" id="noticeClose">✕</span>
    <h2>📢 작두 PT 센터 공지사항</h2>
    <ul id="noticeList"></ul>
  </div>
</div>

<!-- 관리자/트레이너 모달 -->
<div class="admin-modal" id="adminModal">
  <div class="admin-content">
    <span class="admin-close" id="adminClose">✕</span>
    <h2 id="panelTitle">⚙ 관리자/트레이너 패널</h2>

    <div class="tab-btns" id="tabBtns">
      <button class="tab-btn" data-tab="reservations">예약관리</button>
      <button class="tab-btn" data-tab="times">시간설정</button>
      <button class="tab-btn admin-only" data-tab="notices">공지관리</button>
      <button class="tab-btn admin-only" data-tab="roles">권한관리</button>
    </div>

    <!-- 예약 관리 -->
    <div class="tab-content" id="tab-reservations">
      <h3>📅 예약 목록</h3>
      <table class="admin-table">
        <thead><tr><th>고번</th><th>닉네임</th><th>트레이너</th><th>날짜</th><th>시간</th><th>상태</th><th>관리</th></tr></thead>
        <tbody id="adminTable"></tbody>
      </table>
    </div>

    <!-- 시간 설정 (관리자: 전체 / 트레이너: 본인만 요일 세로표) -->
    <div class="tab-content" id="tab-times">
      <div id="timesAdminBlock" style="display:none">
        <h3>🕒 트레이너별 시간 설정(관리자)</h3>
        <p style="margin:6px 0 12px;color:#7b5d49">체크한 시간만 유저 캘린더에 노출됩니다.</p>
        <div id="trainerTimeList"></div>
        <button id="applyTimesAdmin" class="tab-btn" style="margin-top:12px">적용</button>
      </div>

      <div id="timesTrainerBlock" style="display:none">
        <h3>🕒 나의 시간 설정(트레이너)</h3>
        <p style="margin:6px 0 12px;color:#7b5d49">요일을 기준으로 체크한 시간만 예약 가능하게 됩니다.</p>
        <div class="time-grid" id="trainerDayGrid"></div>
        <button id="applyTimesTrainer" class="tab-btn" style="margin-top:12px">적용</button>
      </div>
    </div>

    <!-- 공지 관리 (관리자 전용) -->
    <div class="tab-content" id="tab-notices">
      <h3>📢 공지사항 관리</h3>
      <input id="newNotice" placeholder="공지 내용을 입력하세요" style="width:70%;padding:8px;border:2px solid #ffd6a5;border-radius:10px;">
      <button id="addNotice" class="tab-btn">추가</button>
      <ul id="adminNoticeList"></ul>
    </div>

    <!-- 권한 관리 (관리자 전용) -->
    <div class="tab-content" id="tab-roles">
      <h3>🧑‍💼 권한 관리</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <input id="roleUserId" placeholder="고번 입력" style="padding:8px;width:220px;border:2px solid #ffd6a5;border-radius:10px">
        <input id="roleNickname" placeholder="닉네임 입력" style="padding:8px;width:220px;border:2px solid #ffd6a5;border-radius:10px">
        <select id="roleSelect" style="padding:8px;border:2px solid #ffd6a5;border-radius:10px">
          <option value="member">일반 유저</option>
          <option value="trainer">트레이너</option>
        </select>
        <button id="applyRole" class="tab-btn">적용</button>
      </div>
      <table class="admin-table">
        <thead><tr><th>고번</th><th>닉네임</th><th>권한</th></tr></thead>
        <tbody id="roleTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

/* =======================
      Firebase 설정
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyCmILB2NGpZmkSByWGjN1ZIBlxwQqRpHHg",
  authDomain: "pttt-dc58e.firebaseapp.com",
  projectId: "pttt-dc58e",
  storageBucket: "pttt-dc58e.appspot.com",
  messagingSenderId: "1015121703137",
  appId: "1:1015121703137:web:b4177af397cc5ed74887a0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =======================
      전역 상태/상수
======================= */
const ADMIN_CODE = "admin1234";
const TRAINER_CODE = "trainer1234";

let currentUser = null;        // {id, nick}
let currentRoleForPanel = null; // "admin" | "trainer"
let currentTrainer = 0;
let selectedDate = null;
let bookings = []; // {id, userId, nickname, trainer, date, time, status}

const trainers = [
  {name:"트레이너 A",photo:"https://via.placeholder.com/260x180?text=A",intro:"체형 교정 전문가"},
  {name:"트레이너 B",photo:"https://via.placeholder.com/260x180?text=B",intro:"다이어트 코치"},
  {name:"트레이너 C",photo:"https://via.placeholder.com/260x180?text=C",intro:"근력 향상 전문가"},
  {name:"트레이너 D",photo:"https://via.placeholder.com/260x180?text=D",intro:"재활 트레이너"}
];

const allTimes = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00"];
const daysKo = ["일","월","화","수","목","금","토"];

/* =======================
      엘리먼트
======================= */
const intro = document.getElementById("intro");
const main = document.getElementById("main");
const startBtn = document.getElementById("startBtn");

const trainerCard = document.getElementById("trainerCard");
const trainerTitle = document.getElementById("trainerTitle");
const calendar = document.getElementById("calendar");
const timeSelect = document.getElementById("timeSelect");
const reserveBtn = document.getElementById("reserveBtn");

const noticeBtn = document.getElementById("noticeBtn");
const noticeModal = document.getElementById("noticeModal");
const noticeClose = document.getElementById("noticeClose");
const noticeList = document.getElementById("noticeList");

const adminBtn = document.getElementById("adminBtn");
const adminModal = document.getElementById("adminModal");
const adminClose = document.getElementById("adminClose");
const panelTitle = document.getElementById("panelTitle");
const adminTable = document.getElementById("adminTable");
const tabBtns = document.querySelectorAll(".tab-btn");
const tabReservations = document.getElementById("tab-reservations");
const tabTimes = document.getElementById("tab-times");
const tabNotices = document.getElementById("tab-notices");
const tabRoles = document.getElementById("tab-roles");
const trainerTimeList = document.getElementById("trainerTimeList");
const adminNoticeList = document.getElementById("adminNoticeList");
const roleTable = document.getElementById("roleTable");
const timesAdminBlock = document.getElementById("timesAdminBlock");
const timesTrainerBlock = document.getElementById("timesTrainerBlock");
const trainerDayGrid = document.getElementById("trainerDayGrid");

/* =======================
      유틸
======================= */
function showToast(msg){
  const t=document.createElement("div");
  t.className="toast"; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function getWeekdayKo(yyyymmdd){ // "2025-10-3" ↦ "금" 같은
  const [y,m,d] = yyyymmdd.split("-").map(Number);
  const w = new Date(y, m-1, d).getDay();
  return daysKo[w];
}

/* =======================
      로그인
======================= */
startBtn.onclick = async () => {
  const id = document.getElementById("userId").value.trim();
  const nick = document.getElementById("nickname").value.trim();
  if(!id || !nick) return showToast("고번과 닉네임을 입력하세요!");

  currentUser = { id, nick };
  await setDoc(doc(db,"users",id),{
    nickname:nick, role:"member", updatedAt:new Date()
  }, { merge:true });

  intro.style.opacity="0";
  setTimeout(()=>{ intro.style.display="none"; main.style.display="block"; }, 500);

  await fetchBookings();
  await loadNoticesForUsers();
  showTrainer(currentTrainer);
};

/* =======================
      트레이너/캘린더
======================= */
document.getElementById("prevBtn").onclick = () => {
  currentTrainer = (currentTrainer - 1 + trainers.length) % trainers.length;
  showTrainer(currentTrainer);
};
document.getElementById("nextBtn").onclick = () => {
  currentTrainer = (currentTrainer + 1) % trainers.length;
  showTrainer(currentTrainer);
};

function showTrainer(i){
  const t = trainers[i];
  trainerCard.innerHTML = `<img src="${t.photo}"><h3>${t.name}</h3><p>${t.intro}</p>`;
  trainerTitle.textContent = `${t.name} 일정`;
  renderCalendar();
}

function renderCalendar(){
  calendar.innerHTML = "";
  const now=new Date();
  const todayZero=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const y=now.getFullYear(), m=now.getMonth();
  const fd=new Date(y,m,1), ld=new Date(y,m+1,0);

  for(let i=0;i<fd.getDay();i++){
    const sp=document.createElement("div"); calendar.appendChild(sp);
  }
  for(let d=1;d<=ld.getDate();d++){
    const dateObj=new Date(y,m,d);
    const dateStr = `${y}-${m+1}-${d}`;
    const day=document.createElement("div");
    day.className="day"; day.textContent=d;

    if(dateObj < todayZero) day.classList.add("disabled");
    const hasBooking = bookings.some(b=>b.trainer===trainers[currentTrainer].name && b.date===dateStr);
    if(hasBooking) day.classList.add("booked");

    day.onclick = () => {
      if(day.classList.contains("disabled")) return showToast("이전 날짜는 예약 불가");
      document.querySelectorAll(".day").forEach(c=>c.classList.remove("selected"));
      day.classList.add("selected");
      selectedDate = dateStr;
      updateTimeOptions();
    };
    calendar.appendChild(day);
  }
}

async function getTimesForTrainerAndDate(trainerName, yyyymmdd){
  // 1) 트레이너 개별 스케줄 우선 (trainerSchedule/{nickname}) 요일 키 사용
  const weekday = getWeekdayKo(yyyymmdd); // "월"~"일"
  const docSnap = await getDoc(doc(db,"trainerSchedule",trainerName));
  if(docSnap.exists()){
    const data = docSnap.data();
    if(Array.isArray(data[weekday]) && data[weekday].length) return data[weekday];
  }
  // 2) 관리자 전체 설정(settings/trainerTimes) 보조
  const setSnap = await getDoc(doc(db,"settings","trainerTimes"));
  if(setSnap.exists()){
    const arr = setSnap.data()[trainerName];
    if(Array.isArray(arr) && arr.length) return arr;
  }
  // 3) 기본값
  return allTimes;
}

async function updateTimeOptions(){
  timeSelect.innerHTML = '<option value="">시간 선택</option>';
  if(!selectedDate){ reserveBtn.disabled=true; return; }

  const t = trainers[currentTrainer];
  const availableTimes = await getTimesForTrainerAndDate(t.name, selectedDate);

  const bookedTimes = bookings
    .filter(b=>b.trainer===t.name && b.date===selectedDate)
    .map(b=>b.time);

  let hasAvail = false;
  availableTimes.forEach(time=>{
    const opt=document.createElement("option");
    opt.value=time;
    opt.textContent = bookedTimes.includes(time) ? `${time} (예약됨)` : time;
    if(bookedTimes.includes(time)) opt.disabled = true; else hasAvail = true;
    timeSelect.appendChild(opt);
  });
  reserveBtn.disabled = !hasAvail;
}

/* 예약 생성 (하루 1회 제한 제거됨) */
reserveBtn.onclick = async ()=>{
  if(!currentUser) return showToast("로그인이 필요합니다!");
  if(!selectedDate) return showToast("날짜를 선택하세요!");
  const time = timeSelect.value;
  if(!time) return showToast("시간을 선택하세요!");

  const t = trainers[currentTrainer];
  const dup = bookings.find(b=>b.trainer===t.name && b.date===selectedDate && b.time===time);
  if(dup) return showToast("이미 예약된 시간입니다!");

  await addDoc(collection(db,"reservations"),{
    userId: currentUser.id,
    nickname: currentUser.nick,
    trainer: t.name,
    date: selectedDate,
    time,
    status: "reserved",
    createdAt: new Date()
  });

  showToast(`${currentUser.nick}님의 ${t.name} ${selectedDate} ${time} 예약 완료!`);
  await fetchBookings();
  updateTimeOptions();
};

/* =======================
      예약 데이터 로딩
======================= */
async function fetchBookings(){
  bookings = [];
  const q = await getDocs(collection(db,"reservations"));
  q.forEach(s=>{
    const d=s.data();
    bookings.push({ id:s.id, ...d });
  });
  renderCalendar();
}

/* =======================
      공지사항 (유저 보기)
======================= */
noticeBtn.onclick = async ()=>{
  noticeModal.style.display="flex";
  await loadNoticesForUsers();
};
noticeClose.onclick = ()=> noticeModal.style.display="none";

async function loadNoticesForUsers(){
  noticeList.innerHTML="";
  const q=await getDocs(collection(db,"notices"));
  const arr = []; q.forEach(s=>arr.push({id:s.id, ...s.data()}));
  arr.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  arr.forEach(n=>{
    const li=document.createElement("li");
    li.textContent = n.message;
    noticeList.appendChild(li);
  });
}

/* =======================
      패널 열기(관리자/트레이너)
======================= */
adminBtn.onclick = async ()=>{
  if(!currentUser) return showToast("먼저 로그인하세요!");
  const code = prompt("관리자 또는 트레이너 코드를 입력하세요:");
  if(code===ADMIN_CODE){
    currentRoleForPanel = "admin";
    openPanel("admin");
  }else if(code===TRAINER_CODE){
    currentRoleForPanel = "trainer";
    openPanel("trainer");
  }else{
    showToast("🚫 잘못된 코드입니다.");
  }
};

adminClose.onclick = ()=> adminModal.style.display="none";

function openPanel(role){
  adminModal.style.display="flex";
  // 탭 초기화
  document.querySelectorAll(".tab-content").forEach(el=>el.style.display="none");
  tabBtns.forEach(b=>b.classList.remove("active"));
  // 관리/트레이너 전용 버튼 가시성
  document.querySelectorAll(".admin-only").forEach(el=>{
    el.style.display = (role==="admin") ? "" : "none";
  });

  if(role==="admin"){
    panelTitle.textContent = "⚙ 관리자 패널";
    showTab("reservations");
    loadReservationsTable();
    // 시간설정 관리자 블록 표시
    timesAdminBlock.style.display="block";
    timesTrainerBlock.style.display="none";
    loadTimeSettingsAdminUI();
    loadAdminNotices();
    loadRoles();
  }else{
    panelTitle.textContent = "🧑‍🏫 트레이너 패널";
    // 트레이너는 예약관리 + 시간설정(본인만)
    showTab("reservations");
    loadReservationsTable();
    timesAdminBlock.style.display="none";
    timesTrainerBlock.style.display="block";
    buildTrainerDayGrid(); // UI 만들고
  }
}

// 탭 버튼 동작
tabBtns.forEach(btn=>{
  btn.onclick = ()=>{
    const tab = btn.getAttribute("data-tab");
    // 트레이너는 admin-only 탭 진입 차단
    if(currentRoleForPanel==="trainer" && (tab==="notices"||tab==="roles")) return;
    showTab(tab);
    if(tab==="reservations") loadReservationsTable();
    if(tab==="times"){
      if(currentRoleForPanel==="admin"){ loadTimeSettingsAdminUI(); }
      else { buildTrainerDayGrid(); }
    }
    if(tab==="notices" && currentRoleForPanel==="admin") loadAdminNotices();
    if(tab==="roles" && currentRoleForPanel==="admin") loadRoles();
  };
});

function showTab(tab){
  document.querySelectorAll(".tab-content").forEach(el=>el.style.display="none");
  document.getElementById(`tab-${tab}`).style.display="block";
  tabBtns.forEach(b=>b.classList.remove("active"));
  const tbtn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  if(tbtn) tbtn.classList.add("active");
}

/* =======================
      예약 테이블(공용)
======================= */
async function loadReservationsTable(){
  adminTable.innerHTML="";
  await fetchBookings();
  const role = currentRoleForPanel;
  const filtered = (role==="trainer")
    ? bookings.filter(b=>b.trainer===currentUser.nick) // 닉네임과 트레이너명 동일 가정
    : bookings;

  // 최근 날짜/시간 순
  filtered.sort((a,b)=>{
    const ad=new Date(a.date), bd=new Date(b.date);
    if(ad.getTime()===bd.getTime()) return a.time.localeCompare(b.time);
    return bd.getTime()-ad.getTime();
  });

  filtered.forEach(b=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${b.userId}</td>
      <td>${b.nickname}</td>
      <td>${b.trainer}</td>
      <td>${b.date}</td>
      <td>${b.time}</td>
      <td>${b.status}</td>
      <td>
        <button data-id="${b.id}" class="btn-cancel" style="padding:4px 8px;border:none;border-radius:8px;background:#ffb4a2;cursor:pointer">취소</button>
      </td>
    `;
    adminTable.appendChild(tr);
  });

  adminTable.querySelectorAll(".btn-cancel").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-id");
      if(!confirm("이 예약을 취소하시겠습니까?")) return;
      await deleteDoc(doc(db,"reservations",id));
      showToast("예약이 취소되었습니다.");
      loadReservationsTable();
      fetchBookings(); // 메인 화면 동기화
    };
  });
}

/* =======================
      시간 설정 - 관리자(기존 멀티 트레이너)
======================= */
async function loadTimeSettingsAdminUI(){
  trainerTimeList.innerHTML="";
  const snap = await getDoc(doc(db,"settings","trainerTimes"));
  const data = snap.exists()? snap.data() : {};

  trainers.forEach(t=>{
    const wrap=document.createElement("div");
    wrap.style.cssText="border:1px solid #ffd6a5;border-radius:12px;padding:10px 12px;margin:10px 0;background:#fff";
    wrap.innerHTML = `<h4 style="margin:6px 0 8px;color:#b45309">${t.name}</h4>`;
    const box=document.createElement("div");
    box.style.cssText="display:flex;flex-wrap:wrap;gap:8px";
    allTimes.forEach(tm=>{
      const checked = (data[t.name]||[]).includes(tm) ? "checked" : "";
      const label = document.createElement("label");
      label.className="time-chip";
      label.innerHTML = `<input type="checkbox" value="${tm}" ${checked}/> ${tm}`;
      box.appendChild(label);
    });
    wrap.appendChild(box);
    trainerTimeList.appendChild(wrap);
  });
}

document.getElementById("applyTimesAdmin").onclick = async ()=>{
  const result = {};
  // 각 래퍼에서 h4의 트레이너명 기준으로 수집
  trainerTimeList.querySelectorAll("> div").forEach(container=>{
    const name = container.querySelector("h4").textContent.trim();
    const selected = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
    result[name] = selected;
  });
  await setDoc(doc(db,"settings","trainerTimes"), result);
  showToast("✅ (관리자) 시간 설정 저장됨");
  updateTimeOptions();
};

/* =======================
      시간 설정 - 트레이너 (트레이너 선택 → 요일 선택 → 시간 설정)
======================= */
function buildTrainerDayGrid(){
  const area = timesTrainerBlock;
  area.innerHTML = `
    <h3>🕒 나의 시간 설정(트레이너)</h3>
    <p style="margin:6px 0 12px;color:#7b5d49">트레이너와 요일을 선택 후 시간대를 체크하세요.</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <select id="trainerSelect" style="padding:10px;border:2px solid #ffd6a5;border-radius:10px">
        <option value="">트레이너 선택</option>
      </select>
      <select id="daySelect" style="padding:10px;border:2px solid #ffd6a5;border-radius:10px">
        <option value="">요일 선택</option>
        ${daysKo.map(d=>`<option value="${d}">${d}</option>`).join("")}
      </select>
    </div>
    <div id="timeGrid" style="
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:flex-start;
  margin-bottom:12px;
"></div>
    <button id="applyTimesTrainer" class="tab-btn">적용</button>
  `;

  // ✅ 트레이너 전체 목록 보여주기
  const trainerSelect = area.querySelector("#trainerSelect");
  trainers.forEach(t=>{
    const opt=document.createElement("option");
    opt.value=t.name; 
    opt.textContent=t.name;
    trainerSelect.appendChild(opt);
  });

  const daySelect = area.querySelector("#daySelect");
  const timeGrid = area.querySelector("#timeGrid");

  // 요일 선택 시 시간 표시
  daySelect.onchange = async ()=>{
    const tName = trainerSelect.value;
    const dName = daySelect.value;
    timeGrid.innerHTML = "";
    if(!tName || !dName) return;

    // 시간 리스트 출력
    allTimes.forEach(tm=>{
      const chip=document.createElement("label");
      chip.className="time-chip";
      chip.innerHTML = `<input type="checkbox" value="${tm}"> ${tm}`;
      timeGrid.appendChild(chip);
    });

    // 기존 설정 불러오기
    const snap = await getDoc(doc(db,"trainerSchedule", tName));
    if(snap.exists()){
      const data = snap.data();
      const arr = data[dName] || [];
      timeGrid.querySelectorAll("input").forEach(cb=>{
        cb.checked = arr.includes(cb.value);
      });
    }
  };

  // “적용” 클릭 시 Firestore에 저장
  area.querySelector("#applyTimesTrainer").onclick = async ()=>{
    const tName = trainerSelect.value;
    const dName = daySelect.value;
    if(!tName || !dName) return showToast("트레이너와 요일을 선택하세요!");

    const checkedTimes = Array.from(timeGrid.querySelectorAll("input:checked")).map(i=>i.value);
    const snap = await getDoc(doc(db,"trainerSchedule", tName));
    const data = snap.exists()? snap.data() : {};
    data[dName] = checkedTimes;

    await setDoc(doc(db,"trainerSchedule", tName), data, { merge:true });
    showToast(`✅ ${tName}의 ${dName} 요일 시간 저장 완료`);
  };
}
/* =======================
      공지(관리자)
======================= */
async function loadAdminNotices(){
  adminNoticeList.innerHTML="";
  const q=await getDocs(collection(db,"notices"));
  const arr=[]; q.forEach(s=>arr.push({id:s.id, ...s.data()}));
  arr.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  arr.forEach(n=>{
    const li=document.createElement("li");
    li.style.cssText="background:#fff;border:1px solid #ffd6a5;border-radius:12px;padding:10px 12px;margin:8px 0;display:flex;justify-content:space-between;align-items:center";
    li.innerHTML = `<span>${n.message}</span>
      <button data-id="${n.id}" class="btn-del" style="border:none;border-radius:8px;padding:6px 10px;background:#ffb4a2;cursor:pointer">삭제</button>`;
    adminNoticeList.appendChild(li);
  });
  adminNoticeList.querySelectorAll(".btn-del").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-id");
      if(!confirm("해당 공지를 삭제할까요?")) return;
      await deleteDoc(doc(db,"notices",id));
      loadAdminNotices();
      showToast("🗑️ 공지 삭제됨");
      loadNoticesForUsers();
    };
  });
}

document.getElementById("addNotice").onclick = async ()=>{
  const msg = (document.getElementById("newNotice").value || "").trim();
  if(!msg) return showToast("공지 내용을 입력하세요!");
  await addDoc(collection(db,"notices"),{ message:msg, createdAt:new Date() });
  document.getElementById("newNotice").value="";
  showToast("📢 공지 추가됨");
  loadAdminNotices();
  loadNoticesForUsers();
};

/* =======================
      권한 관리(관리자)
======================= */
async function loadRoles(){
  roleTable.innerHTML="";
  const q=await getDocs(collection(db,"users"));
  const arr=[]; q.forEach(s=>arr.push({id:s.id, ...s.data()}));
  arr.sort((a,b)=> (b.updatedAt?.seconds||0)-(a.updatedAt?.seconds||0));
  arr.forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${u.id}</td><td>${u.nickname||""}</td><td>${u.role||"member"}</td>`;
    roleTable.appendChild(tr);
  });
}

document.getElementById("applyRole").onclick = async ()=>{
  const id = document.getElementById("roleUserId").value.trim();
  const nick = document.getElementById("roleNickname").value.trim();
  const role = document.getElementById("roleSelect").value;
  if(!id || !nick) return showToast("고번과 닉네임을 입력하세요!");

  await setDoc(doc(db,"users",id),{
    nickname:nick, role, updatedAt:new Date()
  }, { merge:true });

  showToast(`✅ ${nick}님을 ${role==="trainer"?"트레이너":"일반 유저"}로 설정했습니다.`);
  loadRoles();
};

/* =======================
      시작
======================= */
function init(){ /* 로그인 후 showTrainer 호출됨 */ }
init();
</script>
</body>
</html>






